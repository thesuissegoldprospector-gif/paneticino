rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function docExists() {
      return resource != null;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && docExists();
    }

    function isApprovedBaker(userId) {
      let bakerDoc =
        get(/databases/$(database)/documents/bakers/$(userId));
      return bakerDoc.data.approvalStatus == 'approved';
    }

    // ----------------------------------------------------------------
    // USERS
    // ----------------------------------------------------------------
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;

      // Allow creation if user is signing up themselves
      // For email/pass, the role is provided in the request
      // For Google, role can be set to 'customer' by default as a safe option
      allow create: if isOwner(userId)
        && request.resource.data.id == userId
        && (request.resource.data.role == 'customer'
            || request.resource.data.role == 'baker'
            // Check for Google provider during initial signup
            || request.auth.token.firebase.sign_in_provider == "google.com");


      allow update: if (isExistingOwner(userId) || isAdmin())
        && request.resource.data.id == resource.data.id
        && request.resource.data.role == resource.data.role
        && request.resource.data.registrationDate == resource.data.registrationDate;

      allow delete: if isExistingOwner(userId) || isAdmin();

      // Cart Subcollection
      match /cart/{cartItemId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ----------------------------------------------------------------
    // CUSTOMERS
    // ----------------------------------------------------------------
    match /customers/{customerId} {
      allow get: if isOwner(customerId) || isAdmin();
      allow list: if false;

      allow create: if isOwner(customerId)
        && request.resource.data.userId == customerId;

      allow update: if (isExistingOwner(customerId) || isAdmin())
        && request.resource.data.userId == resource.data.userId;

      allow delete: if isExistingOwner(customerId) || isAdmin();
    }

    // ----------------------------------------------------------------
    // BAKERS
    // ----------------------------------------------------------------
    match /bakers/{bakerId} {

      // ‚úÖ allow list for everyone (client will filter for 'approved')
      allow list: if true;

      // ‚úÖ profile readable if:
      // - owner
      // - admin
      // - approved
      allow get: if isOwner(bakerId)
        || isAdmin()
        || resource.data.approvalStatus == 'approved';

      // ‚ûï baker application (pending)
      allow create: if isOwner(bakerId)
        && request.resource.data.userId == bakerId
        && request.resource.data.approvalStatus == 'pending';

      // ‚úèÔ∏è update:
      // - baker cannot change approvalStatus
      // - admin can do anything
      allow update: if
        (
          isExistingOwner(bakerId)
          && request.resource.data.userId == resource.data.userId
          && request.resource.data.approvalStatus == resource.data.approvalStatus
        )
        || isAdmin();

      // ‚ùå delete only admin
      allow delete: if isAdmin();
    }

    // ----------------------------------------------------------------
    // PRODUCTS
    // ----------------------------------------------------------------
    match /products/{productId} {

      // üìñ public products
      allow get, list: if true;

      // ‚ûï only approved bakers
      allow create: if isSignedIn()
        && request.resource.data.bakerId == request.auth.uid
        && isApprovedBaker(request.auth.uid);

      // ‚úèÔ∏è only owner
      allow update, delete: if isSignedIn()
        && resource.data.bakerId == request.auth.uid;
    }

    // ----------------------------------------------------------------
    // ORDERS
    // ----------------------------------------------------------------
    match /orders/{orderId} {
        // Customer can create their own order
        allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;

        // Customer who made it, baker who fulfills it, or admin can read
        allow get: if isSignedIn() && (
            resource.data.customerId == request.auth.uid ||
            resource.data.bakerId == request.auth.uid ||
            isAdmin()
        );
        
        // Users can only list their own orders (enforced by client-side query)
        allow list: if isSignedIn();

        // Only the assigned baker can update the status
        allow update: if isSignedIn()
          && resource.data.bakerId == request.auth.uid
          && request.resource.data.keys().hasOnly(['status']);


        // No one can delete orders for now
        allow delete: if false;
    }


    // ----------------------------------------------------------------
    // ADMIN ROLES
    // ----------------------------------------------------------------
    match /roles_admin/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if false;
      allow create, update, delete: if false;
    }
  }
}
